#!/usr/bin/env bash

# This script should provision a remote linux server as an exit node
# usage: PUBLIC_IP=165.227.241.194 ./build/remote root@165.227.241.194

# set -x 
# set -e

cd "$(dirname $0)"

export EXITNODE_DIR=/opt/exitnode
source ./variables

exitnode_ssh=$1
PUBLIC_IP="${PUBLIC_IP:-$(echo $exitnode_ssh | cut -d'@' -f2)}"

ssh $exitnode_ssh echo "testing ssh to $exitnode_ssh"

# rsync these files so we can configure
ssh $exitnode_ssh apt-get install -yq rsync > /dev/null 2>&1
rsync -a ../ "$exitnode_ssh:$EXITNODE_DIR"

# configure
ssh $exitnode_ssh "apt-get clean && apt-get update && dpkg --configure -a" 
ssh -t $exitnode_ssh "PUBLIC_IP=$PUBLIC_IP EXITNODE_DIR=$EXITNODE_DIR $EXITNODE_DIR/create_exitnode.sh"

# reboot
echo "rebooting $exitnode_ssh"
ssh $exitnode_ssh 'nohup sudo reboot &>/dev/null & exit'
# wait for ssh after reboot
echo "Waiting for ssh $exitnode_ssh"
while ! ssh $exitnode_ssh exit
do
    echo "."
    sleep 2
done

ssh "$exitnode_ssh" 'echo remote exitnode provisioned, rebooted'